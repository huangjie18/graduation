#include "sys.h"
#include "delay.h"
#include "usart.h"
#include "adc.h"
#include "pwm.h"
#include "time.h"
#include "led.h"
#include "lcd.h"
#include "stdio.h"
#include "key.h"

//C6-IO4，C7-IO3
char zifu[]=
{
0x04,0x01,0x04,0x11,0x04,0x0D,0x7C,0x03,0x04,0x01,0x04,0x21,0x64,0x21,0x1C,0x3E,
0x84,0x00,0x80,0x00,0xFF,0x7F,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,/*"毕",0*/
0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0x22,0x22,0x24,0x22,0x24,0x12,0x28,0x12,
0x28,0x0A,0x28,0x06,0x20,0x02,0x20,0x02,0x20,0x02,0x20,0x02,0xFF,0x7F,0x00,0x00,/*"业",1*/
0x00,0x00,0x84,0x0F,0x88,0x08,0x88,0x08,0x80,0x08,0x40,0x70,0x2F,0x00,0xC8,0x1F,
0x88,0x10,0x88,0x08,0x08,0x09,0x28,0x05,0x18,0x02,0x08,0x05,0xC0,0x18,0x30,0x60,/*"设",2*/
0x00,0x02,0x04,0x02,0x08,0x02,0x08,0x02,0x00,0x02,0x00,0x02,0xEF,0x7F,0x08,0x02,
0x08,0x02,0x08,0x02,0x08,0x02,0x08,0x02,0x28,0x02,0x18,0x02,0x08,0x02,0x00,0x02,/*"计",3*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,/*"：",4*/
0x20,0x02,0xFC,0x1F,0x20,0x02,0x20,0x02,0xFF,0x7F,0x80,0x00,0xF8,0x0F,0x88,0x08,
0x88,0x08,0xF8,0x0F,0x88,0x08,0x88,0x08,0xF8,0x0F,0x20,0x02,0x10,0x04,0x08,0x08,/*"黄",5*/
0x80,0x00,0x80,0x00,0x80,0x00,0xFE,0x3F,0xC0,0x01,0xA0,0x02,0x90,0x04,0x88,0x08,
0x84,0x10,0x83,0x60,0x80,0x00,0x00,0x00,0x24,0x11,0x44,0x22,0x42,0x22,0x01,0x20,/*"杰",6*/
0x10,0x01,0x10,0x11,0x08,0x09,0x0C,0x07,0x8A,0x01,0x69,0x21,0x08,0x21,0x08,0x3E,
0x88,0x00,0x80,0x00,0xFF,0x7F,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,0x80,0x00,/*"华",7*/
};
char laoshi[]=
{
0x88,0x00,0x88,0x20,0x88,0x1C,0x88,0x03,0xBF,0x40,0x88,0x40,0x08,0x7F,0x28,0x00,
0x98,0x3F,0x8C,0x20,0x8B,0x20,0x88,0x3F,0x88,0x20,0x88,0x20,0x8A,0x3F,0x84,0x20,/*"指",0*/
0x00,0x00,0xFC,0x0F,0x04,0x08,0x04,0x08,0xFC,0x0F,0x04,0x20,0x04,0x20,0xF8,0x3F,
0x00,0x04,0x00,0x04,0xFF,0x7F,0x10,0x04,0x20,0x04,0x20,0x04,0x00,0x05,0x00,0x02,/*"导",1*/
0x40,0x00,0x40,0x10,0xFC,0x0B,0x40,0x04,0x40,0x02,0xFF,0x7F,0x80,0x00,0x40,0x00,
0x30,0x08,0x18,0x07,0xF4,0x00,0x12,0x10,0x11,0x10,0x10,0x10,0xE0,0x1F,0x00,0x00,/*"老",2*/
0x10,0x00,0xD0,0x7F,0x12,0x04,0x12,0x04,0x12,0x04,0x92,0x3F,0x92,0x24,0x92,0x24,
0x92,0x24,0x92,0x24,0x92,0x24,0x90,0x2C,0x88,0x14,0x08,0x04,0x04,0x04,0x02,0x04,/*"师",3*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,/*"：",4*/
0x80,0x00,0x80,0x00,0xFE,0x3F,0xC0,0x01,0xA0,0x02,0x90,0x04,0x8C,0x18,0x83,0x60,
0xF0,0x07,0x00,0x02,0x00,0x01,0xFF,0x7F,0x80,0x00,0x80,0x00,0xA0,0x00,0x40,0x00,/*"李",5*/
0x80,0x00,0x80,0x00,0x40,0x01,0x20,0x02,0x10,0x04,0x08,0x08,0xF4,0x17,0x83,0x60,
0x80,0x00,0x80,0x00,0xF8,0x0F,0x80,0x00,0x80,0x00,0x80,0x00,0xFE,0x3F,0x00,0x00,/*"全",6*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};
char shifu[]=
{
0x88,0x00,0x88,0x20,0x88,0x1C,0x88,0x03,0xBF,0x40,0x88,0x40,0x08,0x7F,0x28,0x00,
0x98,0x3F,0x8C,0x20,0x8B,0x20,0x88,0x3F,0x88,0x20,0x88,0x20,0x8A,0x3F,0x84,0x20,/*"指",0*/
0x00,0x00,0xFC,0x0F,0x04,0x08,0x04,0x08,0xFC,0x0F,0x04,0x20,0x04,0x20,0xF8,0x3F,
0x00,0x04,0x00,0x04,0xFF,0x7F,0x10,0x04,0x20,0x04,0x20,0x04,0x00,0x05,0x00,0x02,/*"导",1*/
0x10,0x00,0xD0,0x7F,0x12,0x04,0x12,0x04,0x12,0x04,0x92,0x3F,0x92,0x24,0x92,0x24,
0x92,0x24,0x92,0x24,0x92,0x24,0x90,0x2C,0x88,0x14,0x08,0x04,0x04,0x04,0x02,0x04,/*"师",2*/
0x10,0x0A,0x10,0x12,0xF0,0x7F,0x08,0x02,0xE8,0x3F,0x2C,0x22,0xEC,0x3F,0x2A,0x22,
0xE9,0x3F,0x28,0x22,0x08,0x10,0xF8,0x7F,0x48,0x10,0x88,0x10,0x88,0x14,0x08,0x08,/*"傅",3*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,/*"：",4*/
0x00,0x02,0x1E,0x02,0x12,0x02,0xEA,0x7F,0x0A,0x01,0x86,0x04,0x8A,0x04,0x52,0x04,
0xD2,0x3F,0x12,0x04,0x96,0x14,0x8A,0x24,0x42,0x44,0x22,0x44,0x02,0x05,0x02,0x02,/*"陈",5*/
0x00,0x00,0x7F,0x3E,0x14,0x22,0x14,0x3E,0x7F,0x22,0x55,0x3E,0x55,0x08,0x55,0x0A,
0x75,0x3E,0x43,0x09,0x41,0x08,0x7F,0x3E,0x41,0x08,0x41,0x08,0x7F,0x7F,0x41,0x00,/*"醒",6*/
0x80,0x00,0x80,0x00,0x40,0x01,0x20,0x02,0x50,0x04,0x8C,0x18,0x83,0x60,0xF0,0x07,
0x00,0x02,0x00,0x01,0x80,0x00,0x10,0x21,0x12,0x49,0x12,0x48,0xE1,0x0F,0x00,0x00,/*"念",7*/
};

char gongshi[]=
{
0x40,0x10,0xE0,0x38,0x1C,0x07,0x04,0x01,0x04,0x01,0x7C,0x01,0x44,0x7F,0x44,0x11,
0x44,0x11,0x7C,0x11,0x04,0x11,0x04,0x11,0x82,0x10,0x82,0x10,0x41,0x10,0x20,0x10,/*"所",0*/
0x40,0x00,0x40,0x00,0x20,0x00,0xFF,0x7F,0x10,0x00,0x10,0x02,0x08,0x02,0x0C,0x02,
0xEA,0x3F,0x09,0x02,0x08,0x02,0x08,0x02,0x08,0x02,0x08,0x02,0xF8,0x7F,0x08,0x00,/*"在",1*/
0x00,0x01,0x20,0x01,0x20,0x01,0x10,0x02,0x10,0x02,0x08,0x04,0x04,0x08,0x42,0x10,
0x41,0x60,0x20,0x00,0x20,0x02,0x10,0x04,0x08,0x04,0xFC,0x0F,0x08,0x08,0x00,0x00,/*"公",2*/
0x00,0x00,0xFC,0x1F,0x00,0x10,0x00,0x10,0xFE,0x17,0x00,0x10,0x00,0x10,0xF8,0x11,
0x08,0x11,0x08,0x11,0x08,0x11,0x08,0x11,0xF8,0x11,0x08,0x11,0x00,0x14,0x00,0x08,/*"司",3*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x0C,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,/*"：",4*/
0x08,0x08,0x10,0x08,0x20,0x04,0x20,0x02,0x00,0x00,0xFE,0x3F,0x00,0x00,0x00,0x00,
0x00,0x00,0xFC,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x7F,0x00,0x00,/*"兰",5*/
0x08,0x01,0x08,0x01,0x08,0x1F,0x88,0x10,0xDF,0x08,0x28,0x05,0x0C,0x02,0x1C,0x05,
0xAA,0x18,0x4A,0x60,0xA9,0x1F,0x88,0x10,0x88,0x10,0x88,0x10,0x88,0x1F,0x88,0x10,/*"格",6*/
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};
u16 target=50;
u8 sta1=1;
int Encode;
extern int Moto1;
extern int Moto2;
extern int Moto3;
extern int Target_position;
extern  u8 statuspid;
void xianshi(void);
void xianshi1(void);
void xianshi2(void);
void xianshi3(void);

int main(void)
{ 
	u16 adcx,count;
	u8 key;
	delay_init(168);
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);
	LCD_Init();
	Adc_Init();
	LED_Init();
	KEY_Init();
	PIDBEGIN1();
	xianshi();
	xianshi1();
	xianshi2();
	xianshi3();
	delay_ms(5000);
	lcd_showpic();
	delay_ms(5000);
	LCD_DrawPoint();
	showstring(0,0,"Target:");
	showstring(0,22,"Actual:");
	showstring(0,44,"Error :");
	TIM8_PWM_Init(500-1,4-1);    //开启和初始化TIM8PWM，频率>10khz可以防止马达鸣叫
	Time_int_Init(100-1,8400-1);  //TIM3初始化和中断开启，PWM的占空比在这里调整，10ms一次
	while(1)
	{
		adcx = Get_Adc_Average(ADC_Channel_5,20); //adc采集20次取平均值
		key=KEY_Scan(1);                          //按键扫描对显示屏进行不同处理或启动一次马达
		if(key)                      //长短按设置
		{
			count++;
			if(count>20)
			{
				count = 20;
			}
		}
		else
		{
			count = 0;
		}
		switch(key)
		{				 
			case KEY4_UP:	
				if(count<10)
					target++;
				else
					target = target + 50;									
							
				break;
			case KEY0_PRES:	
				LED0 = !LED0;
				break;
			case KEY1_PRES:
				if(count<10)
					target--;
				else 
					target = target - 50; 
				break;
			case KEY2_PRES:
/****************出现错误，那么我之前的数据都有错啊*******************************/				
				if(sta1) //因为是支持连按所以加一个状态字防止pid连续重新赋值造成pid值不对
				{        //启动马达一次运行
					statuspid=1;//对pid初值重新赋值
					sta1 = 0;
					TIM_CtrlPWMOutputs(TIM8,ENABLE); 
					TIM_ITConfig(TIM3,TIM_IT_Update,ENABLE);	
				}
				break;
		}
		//限制target的范围
		if(target<=50)
		{
			target = 50;
		}
		else if(target>=4060)
		{
			target = 4060;
		}
		showshuzi(80,0,target);  //显示目标值
		showshuzi(80,22,adcx);       //显示实际adc值
		showshuzi(80,44,abs(target-adcx));//显示误差
		delay_ms(100);
	}
	
}


void xianshi(void) //显示设计者
{
	u8 i,b=0,temp,count=0;
	u16 a;
	LCD_qu(0,0,15,15);
	for(a=0;a<256;a++)
	{
		temp = zifu[a];
		if(count>31)
		{
			b++;
			LCD_qu(b*16,0,(b+1)*16-1,15);
			count = 0;
		}
		count++;
		for(i=0;i<8;i++)
		{
				
			if(temp&0x01) LCD_WR_data(0x00,0x00);
			else LCD_WR_data(0xf8,0x00);
			temp >>= 1;
		}
		delay_ms(5);
	}
}
 
void xianshi1(void) //显示指导老师
{
	u8 i,b=0,temp,count=0;
	u16 a;
	LCD_qu(0,16,15,31);
	for(a=0;a<256;a++)
	{
		temp = laoshi[a];
		if(count>31)
		{
			b++;
			LCD_qu(b*16,16,(b+1)*16-1,31);
			count = 0;
		}
		count++;
		for(i=0;i<8;i++)
		{
				
			if(temp&0x01) LCD_WR_data(0x00,0x00);
			else LCD_WR_data(0x00,0x1f);
			temp >>= 1;
		}
		delay_ms(5);	
	}
}

void xianshi2(void) //显示指导师傅
{
	u8 i,b=0,temp,count=0;
	u16 a;
	LCD_qu(0,32,15,47);
	for(a=0;a<256;a++)
	{
		temp = shifu[a];
		if(count>31)
		{
			b++;
			LCD_qu(b*16,32,(b+1)*16-1,47);
			count = 0;
		}
		count++;
		for(i=0;i<8;i++)
		{
				
			if(temp&0x01) LCD_WR_data(0x00,0x00);
			else LCD_WR_data(0xfc,0x08);
			temp >>= 1;
		}
		delay_ms(5);
	}
}


void xianshi3(void) //显示公司
{
	u8 i,b=0,temp,count=0;
	u16 a;
	LCD_qu(0,48,15,63);
	for(a=0;a<256;a++)
	{
		temp = gongshi[a];
		if(count>31)
		{
			b++;
			LCD_qu(b*16,48,(b+1)*16-1,63);
			count = 0;
		}
		count++;
		for(i=0;i<8;i++)
		{
				
			if(temp&0x01) LCD_WR_data(0x00,0x00);
			else LCD_WR_data(0x07,0xe0);
			temp >>= 1;
		}
		delay_ms(5);

	}
}

